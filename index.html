<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chameleon (with Salamanders)</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #131a31;
      --muted: #9aa7c7;
      --text: #e9eefc;
      --accent: #6aa6ff;
      --accent-2: #7bffb1;
      --danger: #ff6a8b;
      --warning: #ffd166;
      --ok: #6aff9a;
      --radius: 14px;
    }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 10% 10%, #122044 0, var(--bg) 60%), var(--bg);
      color: var(--text);
    }
    .container { max-width: 980px; margin: 0 auto; padding: 28px 16px 60px; }
    h1 { font-size: clamp(24px, 3vw, 36px); margin: 0 0 8px; letter-spacing: 0.4px; }
    p.sub { margin: 0 0 16px; color: var(--muted); }
    .grid { display: grid; gap: 16px; }
    .two { grid-template-columns: repeat(2, minmax(0,1fr)); }
    @media (max-width: 760px) { .two { grid-template-columns: 1fr; } }
    .card { background: linear-gradient(180deg, #151b36 0%, var(--panel) 100%); border: 1px solid #25305a; border-radius: var(--radius); padding: 16px; box-shadow: 0 6px 24px rgba(0,0,0,0.25); }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    label { font-weight: 600; font-size: 14px; }
    input[type="number"], input[type="text"], select, textarea { background: #0f142b; color: var(--text); border: 1px solid #2a3566; border-radius: 10px; padding: 10px 12px; outline: none; width: 100%; box-sizing: border-box; }
    input[type="number"] { max-width: 110px; }
    textarea { min-height: 100px; resize: vertical; }
    .btn { appearance: none; border: 1px solid #2b59ff44; background: linear-gradient(180deg, #2844a8, #203a96); color: white; padding: 10px 14px; border-radius: 12px; font-weight: 700; cursor: pointer; transition: transform .06s ease, filter .15s ease; }
    .btn:hover { filter: brightness(1.05); }
    .btn:active { transform: translateY(1px); }
    .btn.ghost { background: transparent; border-color: #3a476e; color: var(--muted); }
    .btn.warn { background: linear-gradient(180deg, #9f2f45, #7b2234); border-color: #ff6a8b55; }
    .btn.big { padding: 20px 20px; font-size: 18px; }
    .pill { display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 999px; border: 1px solid #2a3566; background: #0f142b; color: var(--muted); font-size: 12px; }
    .list { display: grid; gap: 8px; }
    .player { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px; padding: 10px; border-radius: 12px; background: #0f142b; border: 1px solid #23305f; }
    .name { font-weight: 700; }
    .reveal { font-variant-numeric: tabular-nums; font-size: 16px; color: var(--warning); font-weight: 700; }
    .muted { color: var(--muted); }
    .tag { font-size: 11px; padding: 3px 8px; border-radius: 999px; border: 1px solid #2a3566; color: #c8d2f7; background: #0b1229; }
    .tag.cham { border-color: #28c76f66; color: #28c76f; }
    .tag.sala { border-color: #1dd3c666; color: #1dd3c6; }
    .tag.norm { border-color: #ffffff66; color: #f8f8f8; }
    .spacer { height: 6px; }
    .title-row { display:flex; align-items:center; justify-content:space-between; gap: 10px; }
    .cat { font-weight: 900; letter-spacing: .5px; font-size: 20px; color: var(--warning); text-transform: uppercase; }
    details summary { cursor: pointer; }
    .small { font-size: 12px; color: var(--muted); }

    /* Category selector */
    .checks { display:grid; gap:8px; grid-template-columns: repeat(2, minmax(0,1fr)); }
    @media (max-width:760px){ .checks { grid-template-columns: 1fr; } }
    .checkline { display:flex; align-items:center; gap:10px; background:#0f142b; border:1px solid #23305f; padding:8px 10px; border-radius:10px; }
    .checkline input { width:18px; height:18px; accent-color:#6aa6ff; }
    .toolbar { display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:8px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="title-row">
      <h1>ðŸ¦Ž Jogo do CamaleÃ£o ðŸ¦Ž</h1>
    </div>

    <div class="grid two">
      <section class="card" aria-labelledby="players-h">
        <h2 id="players-h">Jogadores</h2>
        <div class="row" style="justify-content:space-between">
          <label for="numPlayers">Quantos jogadores?</label>
          <div class="row" style="margin-left:auto">
            <button id="btnPMinus" class="btn ghost" type="button" aria-label="decrease players">âˆ’</button>
            <span id="numPlayersDisplay">5</span>
            <button id="btnPPlus" class="btn ghost" type="button" aria-label="increase players">+</button>
          </div>
        </div>
        <div class="spacer"></div>
        <div class="row" style="justify-content:space-between">
          <label for="numSalamanders">Quantas salamandras?</label>
          <div class="row" style="margin-left:auto">
            <button id="btnSMinus" class="btn ghost" type="button" aria-label="decrease salamanders">âˆ’</button>
            <span id="numSalamandersDisplay">1</span>
            <button id="btnSPlus" class="btn ghost" type="button" aria-label="increase salamanders">+</button>
          </div>
        </div>
        <div class="spacer"></div>
        <div id="names" class="list" aria-live="polite"></div>
        <div class="spacer"></div>
      </section>

      <section class="card" aria-labelledby="round-h">
        <h2 id="round-h">Jogo</h2>
        <div class="row" style="justify-content:space-between; align-items:flex-end; flex-wrap:wrap; gap:12px;">
          <div>
            <div class="pill">Categoria <strong id="categoryLabel" class="cat" style="margin-left:8px;">â€”</strong></div>
            <div class="small" id="wordCountInfo"></div>
          </div>
          <div class="row">
            <button id="btnDeal" class="btn big">Jogar!</button>
          </div>
        </div>
        <div class="spacer"></div>

        <details id="catPanel">
          <summary><strong>Selecionar categorias</strong> <span class="small" id="catSelInfo"></span></summary>
          <div class="spacer"></div>
          <div id="categorySelector" class="checks" aria-live="polite"></div>
          <div class="toolbar">
            <button id="btnAllCats" class="btn ghost" type="button">Selecionar todas</button>
            <button id="btnNoCats" class="btn ghost" type="button">Limpar</button>
          </div>
        </details>

        <div class="spacer"></div>
        <div id="playersList" class="list" aria-live="polite"></div>
      </section>
    </div>
  </div>

  <script>
    // ------------------------------
    // Categories (loaded from categories.json in the same folder)
    // ------------------------------
    let WORDLIST = {};

    async function loadCategories(){
      try{
        const url = new URL('./categories.json', window.location.href).toString();
        const res = await fetch(url, { cache: 'no-store' });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        if(!data || typeof data !== 'object' || Array.isArray(data)) throw new Error('Invalid JSON format');
        WORDLIST = data;
      } catch(err){
        alert('Falha ao carregar categories.json. Garanta que o ficheiro existe e Ã© JSON vÃ¡lido. Detalhes: ' + err.message);
        WORDLIST = {};
      }
    }

    // ------------------------------
    // State
    // ------------------------------
    let players = []; // { name, role, word, revealedWord, revealedRole }
    let category = null;
    let trueWord = null;
    let wrongWord = null;
    let currentPlayers = 5;
    let currentSalamanders = 1;
    let selectedCats = new Set();

    // ------------------------------
    // Helpers
    // ------------------------------
    function $(sel, root=document){ return root.querySelector(sel); }
    function el(tag, cls, text){ const e=document.createElement(tag); if(cls) e.className=cls; if(text!=null) e.textContent=text; return e; }
    const rand = (n)=> Math.floor(Math.random()*n);
    const choice = (arr)=> arr[rand(arr.length)];

    function renderCounts(){
      const pd=$('#numPlayersDisplay'); if(pd) pd.textContent = String(currentPlayers);
      const sd=$('#numSalamandersDisplay'); if(sd) sd.textContent = String(currentSalamanders);
    }

    function clampCounts(){
      currentPlayers = Math.max(2, Math.min(16, currentPlayers));
      currentSalamanders = Math.max(0, Math.min(currentPlayers-1, currentSalamanders));
      renderCounts();
    }

    function updateNameInputs(){
      clampCounts();
      const num = currentPlayers;
      const namesDiv = $('#names');
      namesDiv.innerHTML = '';
      for(let i=0;i<num;i++){
        const wrap = el('div','row');
        const lab = el('label'); lab.setAttribute('for','name_'+i); lab.textContent = `Jogador ${i+1}`;
        const inp = el('input'); inp.type='text'; inp.id='name_'+i; inp.placeholder = `nome ${i+1}`;
        inp.value = players[i]?.name || '';
        wrap.append(lab, inp);
        namesDiv.append(wrap);
      }
      players = Array.from({length:num}, (_,i)=> ({ name: $('#name_'+i)?.value?.trim() || '', role: 'Normal', word: null, revealedWord: false, revealedRole: false }));
      renderPlayers();
    }

    function readNames(){ players.forEach((p,i)=>{ const v = $('#name_'+i)?.value?.trim(); if(v) p.name = v; }); }
    function shuffleInPlace(arr){ for(let i=arr.length-1;i>0;i--){ const j=rand(i+1); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

    function renderPlayers(){
      const list = $('#playersList');
      list.innerHTML = '';
      players.forEach((p)=>{
        const row = el('div','player');
        const left = el('div');
        const nm = el('div','name', p.name);
        const roleTag = el('span','tag ' + (p.role==='CamaleÃ£o'?'cham':(p.role==='Salamandra'?'sala':'norm')), p.role);
        roleTag.style.display = p.revealedRole ? 'inline-block' : 'none';
        const revealText = el('div','reveal', p.revealedWord ? (p.word||'') : 'â€”â€”â€”â€”');
        left.append(nm, roleTag, el('div',null,''), revealText);

        const btnWrap = el('div','btns');
        const btnWord = el('button','btn');
        btnWord.textContent = p.revealedWord ? 'Esconder palavra' : 'Revelar palavra';
        btnWord.addEventListener('click', ()=>{
          p.revealedWord = !p.revealedWord;
          revealText.textContent = p.revealedWord ? (p.word||'') : 'â€”â€”â€”â€”';
          btnWord.textContent = p.revealedWord ? 'Esconder palavra' : 'Revelar palavra';
        });

        const btnRole = el('button','btn ghost');
        btnRole.textContent = p.revealedRole ? 'Esconder papel' : 'Revelar papel';
        btnRole.addEventListener('click', ()=>{
          p.revealedRole = !p.revealedRole;
          roleTag.style.display = p.revealedRole ? 'inline-block' : 'none';
          btnRole.textContent = p.revealedRole ? 'Esconder papel' : 'Revelar papel';
        });

        btnWrap.append(btnWord, btnRole);
        row.append(left, btnWrap);
        list.append(row);
      });

      $('#categoryLabel').textContent = category || 'â€”';
      const words = category ? WORDLIST[category] : null;
      $('#wordCountInfo').textContent = words ? `${words.length} palavras nesta categoria` : '';
    }

    // ------------------------------
    // Category Selection
    // ------------------------------
    function saveSelectedCats(){
      try{ localStorage.setItem('selectedCats', JSON.stringify(Array.from(selectedCats))); }catch{}
    }

    function loadSelectedCats(){
      try{
        const raw = localStorage.getItem('selectedCats');
        const saved = raw ? JSON.parse(raw) : null;

        const validCats = Object.keys(WORDLIST).filter(k => !k.startsWith('_'));

        if (Array.isArray(saved) && saved.length){
          selectedCats = new Set(saved.filter(c => validCats.includes(c)));
        } else {
          const defs = Array.isArray(WORDLIST._defaults) ? WORDLIST._defaults : [];
          selectedCats = new Set(defs.filter(c => validCats.includes(c)));
        }
      }catch{
        selectedCats = new Set();
      }
    }

    function renderCategorySelector(){
      const holder = $('#categorySelector');
      holder.innerHTML = '';

      const cats = Object.keys(WORDLIST).filter(k => !k.startsWith('_'));

      cats.forEach((c)=>{
        const line = el('label','checkline');
        const cb = el('input'); cb.type='checkbox'; cb.checked = selectedCats.has(c);
        cb.addEventListener('change', ()=>{
          if(cb.checked) selectedCats.add(c); else selectedCats.delete(c);
          updateCatSelInfo();
          saveSelectedCats();
        });
        const span = el('span', null, `${c} `);
        const count = WORDLIST[c]?.length ?? 0;
        const small = el('span','small', `(${count})`);
        line.append(cb, span, small);
        holder.append(line);
      });

      updateCatSelInfo();
    }

    function updateCatSelInfo(){
      const total = Object.keys(WORDLIST).filter(k => !k.startsWith('_')).length;
      const sel = Array.from(selectedCats).filter(k => !k.startsWith('_')).length;
      $('#catSelInfo').textContent = `â€” ${sel}/${total} selecionadas`;
    }

    function selectAllCats(){
      const defs = Array.isArray(WORDLIST._defaults) ? WORDLIST._defaults : [];
      const validCats = Object.keys(WORDLIST).filter(k => !k.startsWith('_'));
      selectedCats = new Set(defs.filter(c => validCats.includes(c)));
      renderCategorySelector();
      saveSelectedCats();
    }

    function clearAllCats(){
      selectedCats.clear();
      renderCategorySelector();
      saveSelectedCats();
    }

    // ------------------------------
    // Game Logic
    // ------------------------------
    function pickCategoryAndWords(){
      const cats = Array.from(selectedCats);
      if(cats.length===0){ alert('Nenhuma categoria selecionada. Selecione pelo menos uma.'); return; }
      category = choice(cats);
      const words = WORDLIST[category];
      if(!Array.isArray(words) || words.length < 2){ alert(`A categoria "${category}" precisa de pelo menos 2 palavras.`); return; }
      trueWord = choice(words);
      do { wrongWord = choice(words); } while (wrongWord === trueWord);
    }

    function dealRound(){
      readNames();
      pickCategoryAndWords();
      if(!category || !trueWord) return;

      // reset
      players.forEach(p=>{ p.role='Normal'; p.word=null; p.revealedWord=false; p.revealedRole=false; });

      // assign roles
      const chamIndex = rand(players.length);
      players[chamIndex].role = 'CamaleÃ£o';

      let numSala = Math.max(0, Math.min(players.length-1, currentSalamanders));

      const indexes = players.map((_,i)=>i).filter(i=>i!==chamIndex);
      shuffleInPlace(indexes);
      const salaIndexes = indexes.slice(0, numSala);
      salaIndexes.forEach(i=> players[i].role = 'Salamandra');

      // assign words
      players.forEach((p)=>{
        if(p.role==='CamaleÃ£o'){ p.word = 'Ã‰s o camaleÃ£o!'; }
        else if(p.role==='Salamandra'){ p.word = wrongWord; }
        else { p.word = trueWord; }
      });

      renderPlayers();
    }

    // ------------------------------
    // Init & Events
    // ------------------------------
    $('#btnDeal').addEventListener('click', dealRound);

    // plus/minus events
    $('#btnPMinus').addEventListener('click', ()=>{ currentPlayers = Math.max(2, currentPlayers-1); clampCounts(); updateNameInputs(); });
    $('#btnPPlus').addEventListener('click', ()=>{ currentPlayers = Math.min(16, currentPlayers+1); clampCounts(); updateNameInputs(); });
    $('#btnSMinus').addEventListener('click', ()=>{ currentSalamanders = Math.max(0, currentSalamanders-1); clampCounts(); });
    $('#btnSPlus').addEventListener('click', ()=>{ currentSalamanders = Math.min(currentPlayers-1, currentSalamanders+1); clampCounts(); });

    $('#btnAllCats').addEventListener('click', selectAllCats);
    $('#btnNoCats').addEventListener('click', clearAllCats);

    // start
    (async function start(){
      await loadCategories();
      loadSelectedCats();
      clampCounts();
      updateNameInputs();
      renderCategorySelector();
    })();
  </script>
</body>
</html>
